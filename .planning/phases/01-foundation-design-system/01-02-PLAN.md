---
phase: 01-foundation-design-system
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - lib/store.ts
  - components/StoreHydration.tsx
  - components/ThemeApplicator.tsx
  - components/StarryBackground.tsx
  - components/LanguagePicker.tsx
  - components/TitleScreen.tsx
  - app/layout.tsx
  - app/page.tsx
autonomous: true
requirements:
  - PWA-03
  - PWA-06
must_haves:
  truths:
    - "Running npm run dev opens a page with an animated starry night background showing twinkling stars and occasional shooting stars"
    - "The starry background renders with a gold/purple accent sky gradient matching the active theme preset"
    - "A Zustand store persists childName, theme, mode, starDensity, starDepth, goldIntensity, story, style, and referenceImageUrl to localStorage"
    - "Persisted store data survives a full page reload without hydration errors"
    - "A full-screen language picker appears as the first screen with 3 large buttons for French, English, Ukrainian"
    - "After selecting a language, an animated title screen shows a time-aware greeting and 'Begin the Adventure' CTA"
    - "npm run build completes without errors"
  artifacts:
    - path: "lib/store.ts"
      provides: "Zustand store with persist middleware and skipHydration"
      exports: ["useStoryStore"]
      contains: "skipHydration"
    - path: "components/StoreHydration.tsx"
      provides: "Client component that rehydrates Zustand store on mount"
      contains: "rehydrate"
    - path: "components/ThemeApplicator.tsx"
      provides: "Client component that applies data-theme and data-mode to html element"
      contains: "dataset.theme"
    - path: "components/StarryBackground.tsx"
      provides: "Canvas-based animated starry sky with configurable density and depth"
      contains: "requestAnimationFrame"
      min_lines: 80
    - path: "components/LanguagePicker.tsx"
      provides: "Full-screen 3-language selection overlay"
      contains: "locale"
    - path: "components/TitleScreen.tsx"
      provides: "Animated greeting with time-aware message and CTA button"
      contains: "getGreetingKey"
  key_links:
    - from: "lib/store.ts"
      to: "types/store.ts"
      via: "imports StoreState and StoreActions types"
      pattern: "import.*StoreState|StoreActions.*from.*@/types/store"
    - from: "components/StarryBackground.tsx"
      to: "lib/store.ts"
      via: "reads starDensity and starDepth from store"
      pattern: "useStoryStore.*starDensity|starDepth"
    - from: "components/ThemeApplicator.tsx"
      to: "lib/store.ts"
      via: "reads theme and mode from store"
      pattern: "useStoryStore.*theme|mode"
    - from: "components/LanguagePicker.tsx"
      to: "app/page.tsx"
      via: "onSelect callback transitions to title screen"
      pattern: "onSelect"
    - from: "components/TitleScreen.tsx"
      to: "lib/greeting.ts"
      via: "imports getGreetingKey for time-aware greeting"
      pattern: "getGreetingKey"
    - from: "components/TitleScreen.tsx"
      to: "lib/store.ts"
      via: "reads childName from store for greeting personalization"
      pattern: "useStoryStore.*childName"
    - from: "app/layout.tsx"
      to: "components/StoreHydration.tsx"
      via: "renders StoreHydration in body for rehydration"
      pattern: "StoreHydration"
    - from: "app/layout.tsx"
      to: "components/ThemeApplicator.tsx"
      via: "renders ThemeApplicator in body for theme application"
      pattern: "ThemeApplicator"
    - from: "app/layout.tsx"
      to: "components/StarryBackground.tsx"
      via: "renders StarryBackground as persistent background layer"
      pattern: "StarryBackground"
---

<objective>
Build the Zustand store with localStorage persistence, the animated starry night canvas background, and the landing page experience (language picker into title screen with greeting and CTA).

Purpose: This plan delivers the three core Phase 1 requirements: animated starry background (PWA-03), localStorage persistence (PWA-06), and the landing experience that ties the visual identity together. After this plan, the app has its full visual identity and state infrastructure.
Output: A working landing page with animated stars, language selection, personalized greeting, and persistent state.
</objective>

<execution_context>
@C:/Users/troman/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/troman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-design-system/01-CONTEXT.md
@.planning/phases/01-foundation-design-system/01-RESEARCH.md
@.planning/phases/01-foundation-design-system/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand store with localStorage persistence and theme/hydration components</name>
  <files>
    lib/store.ts
    components/StoreHydration.tsx
    components/ThemeApplicator.tsx
    app/layout.tsx
  </files>
  <action>
1. Create `lib/store.ts`:
   - Import `create` from `zustand` and `persist` from `zustand/middleware`
   - Import `StoreState` and `StoreActions` from `@/types/store`
   - Define `StoryStudioStore = StoreState & StoreActions`
   - Create the store with `persist` middleware:
     - Default values: `childName: 'Evan'`, `theme: 'mystical'`, `mode: 'dark'`, `starDensity: 'medium'`, `starDepth: 'flat'`, `goldIntensity: 0.5`, `story: null`, `style: 'watercolor'`, `referenceImageUrl: null`, `status: 'idle'`, `currentImageIndex: 0`, `error: null`
     - Actions: `setChildName`, `setTheme`, `setMode`, `setStarDensity`, `setStarDepth`, `setGoldIntensity`, `setStory`, `setStyle`, `setReferenceImageUrl`, `setStatus`, `setError`, `reset` (resets story, status, currentImageIndex, error)
     - Persist config: `name: 'evan-story-studio'`, `skipHydration: true`
     - `partialize`: Only persist `childName`, `theme`, `mode`, `starDensity`, `starDepth`, `goldIntensity`, `story`, `style`, `referenceImageUrl`. Exclude transient state (`status`, `currentImageIndex`, `error`).
   - Export `useStoryStore`

2. Create `components/StoreHydration.tsx` (client component):
   - `'use client'` directive
   - In `useEffect` on mount, call `useStoryStore.persist.rehydrate()`
   - Return `null` (render-nothing component)

3. Create `components/ThemeApplicator.tsx` (client component):
   - `'use client'` directive
   - Read `theme` and `mode` from `useStoryStore`
   - In `useEffect`, set `document.documentElement.dataset.theme = theme` and `document.documentElement.dataset.mode = mode`
   - Return `null`

4. Update `app/layout.tsx` (from Plan 01):
   - Add `<StoreHydration />` inside `<body>` (before children)
   - Add `<ThemeApplicator />` inside `<body>` (before children)
   - Add `<StarryBackground />` inside `<body>` (before children) -- will be created in Task 2 but add the import and usage now; if the file doesn't exist yet, create a minimal placeholder
   - Keep all existing font, i18n, and metadata setup from Plan 01

5. Test persistence: Open browser, verify localStorage key `evan-story-studio` appears. Modify a setting via browser console (`useStoryStore.getState().setTheme('dreamy')`), refresh page, confirm the value persists. Confirm NO hydration mismatch errors in console.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - No React hydration mismatch warnings in browser console
    - `localStorage.getItem('evan-story-studio')` returns a JSON string with persisted fields
    - After page reload, persisted values are restored (no flash to defaults)
    - `npx tsc --noEmit` passes
  </verify>
  <done>Zustand store persists settings and story data to localStorage, survives page reload without hydration errors, and theme/mode are applied to the html element via data attributes</done>
</task>

<task type="auto">
  <name>Task 2: Build StarryBackground canvas and landing page with language picker and title screen</name>
  <files>
    components/StarryBackground.tsx
    components/LanguagePicker.tsx
    components/TitleScreen.tsx
    app/page.tsx
  </files>
  <action>
1. Create `components/StarryBackground.tsx` (client component):
   - `'use client'` directive
   - Full-screen `<canvas>` element: `className="fixed inset-0 -z-10 pointer-events-none"`, `aria-hidden="true"`
   - Read `starDensity` and `starDepth` from `useStoryStore`
   - Read sky gradient colors from CSS custom properties (`--color-sky-top`, `--color-sky-bottom`) via `getComputedStyle(document.documentElement)`
   - Star generation:
     - Density map: `{ sparse: 30, medium: 60, dense: 100 }`
     - Each star: `{ x, y, radius (0.5-2.0), opacity, twinkleSpeed (0.005-0.025), twinklePhase (random), layer (0|1|2) }`
   - Animation loop with `requestAnimationFrame`:
     - Use delta-time calculation for consistent speed across frame rates (iPad Safari may throttle to 30fps)
     - Clear canvas, draw sky gradient (linear from top to bottom using the CSS color values)
     - Draw each star as a filled arc with oscillating opacity: `opacity = baseOpacity * (0.5 + 0.5 * Math.sin(twinklePhase + time * twinkleSpeed))`
     - Star color: white with slight gold tint for some stars (matches gold accent theme)
   - Shooting stars:
     - Spawn randomly: average 1 every 5 seconds (use delta-time accumulator, not frame counting)
     - Each shooting star: `{ x, y, length (~40-80px), speed, angle (~30-45 degrees), opacity, life (0-1) }`
     - Draw as a line with gradient trail (bright head, fading tail)
     - Remove when `life >= 1`
   - Parallax mode (when `starDepth === 'parallax'`):
     - 3 layers with different drift speeds: back (0.1px/s), mid (0.3px/s), front (0.5px/s)
     - Subtle continuous horizontal drift (no mouse/gyro input needed for v1)
   - Resize handler: update canvas dimensions on `window.resize`
   - Cleanup: cancel `requestAnimationFrame` and remove resize listener on unmount
   - Re-generate stars when `density` or `depth` changes (dependency array of useEffect)
   - Performance: Stars are simple `arc()` calls, no shadows or blur. Capped at 100 max.

2. Create `components/LanguagePicker.tsx` (client component):
   - `'use client'` directive
   - Props: `onSelect: () => void`
   - Full-screen overlay: `className="fixed inset-0 z-50 flex items-center justify-center"` (sits above StarryBackground)
   - Three large buttons arranged vertically with generous spacing for child-friendly tapping:
     - Each button: rounded corners (use `rounded-2xl` or similar), frosted glass effect (`backdrop-blur-md bg-card-bg`), gold border accent on hover
     - Button text: flag emoji + language name (Francais, English, Ukrainian name in Cyrillic)
     - Each button is large enough for a 4-year-old to tap (min 80px height, generous padding)
   - On button click:
     - Set cookie: `document.cookie = \`locale=${locale};path=/;SameSite=Lax\``
     - Do NOT set an expiry (session cookie -- per user decision, picker shows on every launch)
     - Call `router.refresh()` from `next/navigation` to re-render server components with new locale
     - Call `onSelect()` to transition to title screen
   - Use `motion/react` for entrance animation: buttons fade/scale in with staggered timing
   - Do NOT use `useTranslations` here -- language names are always shown in their own language (hardcoded)

3. Create `components/TitleScreen.tsx` (client component):
   - `'use client'` directive
   - Props: `onBegin: () => void` (for future navigation to character picker)
   - Read `childName` from `useStoryStore`
   - Import `getGreetingKey` from `@/lib/greeting` and `useTranslations` from `next-intl`
   - Display:
     - App title "Evan's Story Studio" in large heading font (font-heading class) with gold accent color
     - Time-aware greeting: `t(getGreetingKey(), { name: childName })` -- e.g., "Good evening, Evan"
     - CTA button: `t('landing.cta')` -- "Begin the Adventure" (translated per locale)
     - Subtle gear icon in bottom-right corner for settings access (use a simple SVG cog icon, non-functional for now -- settings page is deferred)
   - Button styling: solid background with gold accent, glowy effect (`shadow-lg shadow-glow`), rounded corners, large touch target
   - Use `motion/react` for animations:
     - Title fades in and scales up slightly
     - Greeting fades in with a slight delay
     - CTA button slides up from below with spring animation
   - The `onBegin` handler: for now, can just log to console since character picker is Phase 3. Later phases will wire this to navigation.

4. Rewrite `app/page.tsx`:
   - `'use client'` directive (needed for useState to manage language picker vs title screen state)
   - Use `useState` to track screen state: `'language-picker' | 'title-screen'`
   - Default to `'language-picker'` (shown on every app launch per user decision)
   - When `state === 'language-picker'`: render `<LanguagePicker onSelect={() => setState('title-screen')} />`
   - When `state === 'title-screen'`: render `<TitleScreen onBegin={() => { /* future: navigate to /story */ }} />`
   - The `StarryBackground` is rendered in layout.tsx (always visible behind both screens)

5. Verify the complete flow:
   - `npm run dev` -> page loads -> language picker appears over starry background
   - Tap a language -> title screen appears with time-appropriate greeting and CTA
   - Stars twinkle continuously, shooting stars appear periodically
   - `npm run build` completes without errors
  </action>
  <verify>
    - `npm run dev` shows animated starry background with twinkling stars
    - Shooting stars appear approximately every 5 seconds
    - Language picker displays 3 large buttons on first load
    - Clicking a language transitions to title screen
    - Title screen shows time-appropriate greeting with "Evan" (or configured name)
    - CTA button text matches selected language
    - No console errors or hydration warnings
    - `npm run build` completes with exit code 0
    - `localStorage.getItem('evan-story-studio')` persists across page reload
  </verify>
  <done>Animated starry night background with twinkling stars and shooting stars renders behind all content. Full-screen language picker transitions to animated title screen with time-aware greeting and translated CTA. The complete Phase 1 visual identity is established. npm run build succeeds.</done>
</task>

</tasks>

<verification>
Phase 1 is complete when ALL of the following are true:
1. `npm run dev` opens a page with an animated starry night background and gold/purple accent palette
2. Headings render in Fredoka (Comfortaa for Ukrainian) and body text renders in Nunito
3. A Zustand store persists data to localStorage and survives page reload without hydration errors
4. TypeScript types for Story, Page, Character, and Style are defined and importable
5. `npm run build` completes without errors
6. Language picker appears on launch with 3 languages, transitions to greeting + CTA
7. Three theme presets (mystical, dreamy, magical) are defined in CSS and switchable via data-theme attribute
8. i18n works end-to-end: selecting a language changes the CTA text
</verification>

<success_criteria>
- The animated starry background runs smoothly with twinkling and shooting stars (PWA-03)
- Typography displays correctly in Fredoka/Comfortaa headings and Nunito body (PWA-05)
- Store state persists across reloads without hydration issues (PWA-06)
- The landing experience flows: language picker -> animated title screen -> CTA
- All three theme presets and dark/light mode are defined and applicable
- npm run build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-design-system/01-02-SUMMARY.md`
</output>
